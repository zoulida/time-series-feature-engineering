# IC检测工作流批量版 - 重构版

## 📁 目录结构

```
IC检测批量/
├── shared/                                    # 共享组件目录
│   ├── __init__.py                           # 共享模块包初始化
│   ├── memory_monitor.py                     # 内存监控类
│   ├── progress_tracker.py                   # 进度跟踪类
│   └── utils.py                              # 工具函数
├── step1_get_stock_data_batch.py             # 步骤1: 批量获取股票数据
├── step2_select_factors_batch.py             # 步骤2: 批量选择因子
├── step3_generate_training_data_batch.py     # 步骤3: 批量生成训练数据
├── step4_ic_analysis_batch.py                # 步骤4: 批量IC分析
├── run_ic_workflow_batch_refactored.py       # 主工作流协调器（重构版）
├── run_batch_refactored.py                   # 运行脚本（重构版）
├── data/                                     # 数据目录
│   ├── analyze_ic_results.py                # IC结果分析脚本
│   └── ic_results_batch_*.json              # IC分析结果文件
└── README_重构版.md                          # 本文档
```

## 🔧 重构改进

### 1. 模块化设计
- **shared/**: 共享组件，避免代码重复
- **step1-4**: 每个步骤独立模块，职责清晰
- **主协调器**: 只负责协调各模块，不包含具体业务逻辑

### 2. 代码结构优化
- **原文件**: `run_ic_workflow_batch.py` (984行)
- **重构后**: 每个模块200-300行，更易维护
- **职责分离**: 每个模块只负责自己的功能

### 3. 接口标准化
- **统一配置**: 所有模块使用相同的配置对象
- **标准接口**: 每个模块都有清晰的输入输出
- **错误处理**: 统一的错误处理和日志记录

## 🚀 使用方法

### 运行重构版工作流
```bash
# 进入目录
cd source/IC检测批量

# 运行重构版
python run_batch_refactored.py
```

### 分析IC结果
```bash
# 进入数据目录
cd data

# 运行分析脚本
python analyze_ic_results.py
```

## 📊 各模块功能

### shared/ 共享组件

#### MemoryMonitor (内存监控)
- 实时监控系统内存使用情况
- 防止内存溢出
- 支持强制垃圾回收

#### ProgressTracker (进度跟踪)
- 实时显示工作流执行进度
- 耗时统计和剩余时间估算
- 支持检查点保存和恢复

#### Utils (工具函数)
- 文件清理
- 依赖检查
- 性能统计
- 通用工具函数

### step1_get_stock_data_batch.py (获取股票数据)
- **功能**: 批量获取股票数据
- **特点**: 支持内存优化、数据过滤
- **输出**: 股票数据字典

### step2_select_factors_batch.py (选择因子)
- **功能**: 从统一因子库选择因子
- **特点**: 支持分类选择、多样性保证
- **输出**: 选中的因子列表

### step3_generate_training_data_batch.py (生成训练数据)
- **功能**: 分批生成训练数据
- **特点**: 因子计算、收益率计算、技术指标
- **输出**: 训练数据DataFrame

### step4_ic_analysis_batch.py (IC分析)
- **功能**: 计算IC值和生成报告
- **特点**: Pearson和Spearman相关系数
- **输出**: IC分析结果和报告

## 🔄 数据流

```
配置 → 步骤1(股票数据) → 步骤2(因子选择) → 步骤3(训练数据) → 步骤4(IC分析) → 结果
```

## 📈 性能优化

### 内存管理
- 分批处理避免内存溢出
- 实时内存监控
- 自动垃圾回收

### 进度监控
- 实时进度显示
- 性能统计
- 错误恢复

### 代码质量
- 模块化设计
- 清晰的接口
- 统一的错误处理

## 🛠️ 配置说明

### 测试模式
- 股票数量: 100只
- 因子数量: 50个
- 适合快速验证功能

### 生产模式
- 股票数量: 5000只
- 因子数量: 500个
- 适合大规模数据分析

## 📝 日志文件

- `ic_workflow_batch_refactored.log`: 主工作流日志
- `data/ic_results_batch_*.json`: IC分析结果
- `data/ic_report_batch_*.csv`: IC分析报告

## 🔍 故障排除

### 常见问题
1. **内存不足**: 减少批次大小或股票数量
2. **因子计算失败**: 检查因子库配置
3. **数据加载失败**: 检查数据源路径

### 调试方法
1. 查看日志文件
2. 检查配置参数
3. 验证数据源

## 📚 扩展开发

### 添加新步骤
1. 创建新的步骤模块
2. 实现标准接口
3. 在主协调器中调用

### 添加新功能
1. 在shared/中添加共享组件
2. 在各步骤模块中使用
3. 更新配置和文档

## 🎯 优势总结

1. **可维护性**: 模块化设计，代码清晰
2. **可扩展性**: 易于添加新功能
3. **可测试性**: 每个模块可独立测试
4. **可读性**: 职责分离，逻辑清晰
5. **性能**: 内存优化，进度监控
